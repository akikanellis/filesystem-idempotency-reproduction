# Filesystem Idempotency Reproduction

A repo for reproducing the issue in https://github.com/dev-sec/ansible-collection-hardening/pull/718

## Reproducing The Issue

Install dependencies

```shell
python -m venv env
source env/bin/activate
pip install --requirement requirements.txt
source env/bin/activate
ansible-galaxy install --role-file requirements.yml
```

Run molecule VM tests

```shell
source env/bin/activate
molecule test -s vm -- -vv
```

or Docker tests (they both fail on the `idempotence` step)

```shell
source env/bin/activate
molecule test -s docker -- -vv
```

`Disable unused filesystems | os-10` result after executing Molecule's `converge`

```log
TASK [devsec.hardening.os_hardening : Disable unused filesystems | os-10] ******
task path: /home/aki/.ansible/collections/ansible_collections/devsec/hardening/roles/os_hardening/tasks/modprobe.yml:23
changed: [ubuntu] => {"changed": true, "checksum": "67a3d89da14f003d0c793299ed436d6489ca6dc7", "dest": "/etc/modprobe.d/dev-sec.conf", "gid": 0, "group": "root", "md5sum": "62f1f1e11b1c4e7836c3272cb1cf4466", "mode": "0644", "owner": "root", "size": 374, "src": "/home/vagrant/.ansible/tmp/ansible-tmp-1700480903.2189353-40714-255180519396209/source", "state": "file", "uid": 0}
```

`/etc/modprobe.d/dev-sec.conf` contents after executing Molecule's `converge`

```shell
#
# Ansible managed: Do NOT edit this file manually!
#
# Generated by Ansible role devsec.hardening.os_hardening

install hfsplus /bin/true
install tipc /bin/true
install vfat /bin/true
install jffs2 /bin/true
install cramfs /bin/true
install sctp /bin/true
install hfs /bin/true
install rds /bin/true
install dccp /bin/true
install freevxfs /bin/true
install udf /bin/true
```

`Disable unused filesystems | os-10` result after executing Molecule's `idempotence`

```log
TASK [devsec.hardening.os_hardening : Disable unused filesystems | os-10] ******
task path: /home/aki/.ansible/collections/ansible_collections/devsec/hardening/roles/os_hardening/tasks/modprobe.yml:23
changed: [ubuntu] => {"changed": true, "checksum": "67a3d89da14f003d0c793299ed436d6489ca6dc7", "dest": "/etc/modprobe.d/dev-sec.conf", "gid": 0, "group": "root", "md5sum": "62f1f1e11b1c4e7836c3272cb1cf4466", "mode": "0644", "owner": "root", "size": 374, "src": "/home/vagrant/.ansible/tmp/ansible-tmp-1700480903.2189353-40714-255180519396209/source", "state": "file", "uid": 0}
```

`/etc/modprobe.d/dev-sec.conf` contents after executing Molecule's `idempotence`

```shell
#
# Ansible managed: Do NOT edit this file manually!
#
# Generated by Ansible role devsec.hardening.os_hardening

install jffs2 /bin/true
install udf /bin/true
install hfs /bin/true
install tipc /bin/true
install sctp /bin/true
install vfat /bin/true
install cramfs /bin/true
install freevxfs /bin/true
install hfsplus /bin/true
install rds /bin/true
install dccp /bin/true
```
